<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Probabilistic forecast reconciliation • FoReco026</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Probabilistic forecast reconciliation">
<meta property="og:description" content="FoReco026">
<meta property="og:image" content="https://danigiro.github.io/FoReco026/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FoReco026</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.2.6.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-book"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-question-circle"></span>
     
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/FoReco_package.html">Using the FoReco package</a>
    </li>
    <li>
      <a href="../articles/accuracy_indices.html">Average relative accuracy indices</a>
    </li>
    <li>
      <a href="../articles/FoReco_prob.html">Probabilistic forecast reconciliation</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/daniGiro/FoReco" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://cran.r-project.org/web/packages/FoReco/index.html" class="external-link">
    <span class="fab fa-r-project fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Probabilistic forecast reconciliation</h1>
                        <h4 data-toc-skip class="author">Daniele
Girolimetto</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/daniGiro/FoReco026/blob/HEAD/vignettes/articles/FoReco_prob.Rmd" class="external-link"><code>vignettes/articles/FoReco_prob.Rmd</code></a></small>
      <div class="hidden name"><code>FoReco_prob.Rmd</code></div>

    </div>

    
    
<p>Probabilistic forecast reconciliation is a statistical procedure for
generating coherent and accurate forecasts across multiple time series.
<code>FoReco</code> is an R package that provides an implementation of
this technique, using the methods proposed by Panagiotelis et al. (2022)
and Girolimetto et al. (2023). The package is flexible and can be used
to perform reconciliation on cross-sectional, temporal, and
cross-temporal data. In particular we can calculate both point and
probabilistic forecasts, and allows for the specification of other
constraints (like non-negativity issues) to ensure that the forecasts
are consistent with each other. In this vignette, we will walk through
the basics of using <code>FoReco</code> for probabilistic forecast
reconciliation.</p>
<p>To get started, we need to load the necessary libraries and set a
sample size for the probabilistic forecasts sample:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pkg.robjhyndman.com/forecast/" class="external-link">forecast</a></span><span class="op">)</span> <span class="co"># the data and the forecasting function</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span>     <span class="co"># simulate from a multivariate normal distribution</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/daniGiro/FoReco026" class="external-link">FoReco026</a></span><span class="op">)</span>   <span class="co"># bootstrap and reconciliation phase</span></span>
<span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fl">1000</span>         <span class="co"># Sample size for the probabilistic forecasts sample</span></span></code></pre></div>
<div class="section level3">
<h3 id="cross-sectional-framework">Cross-sectional framework<a class="anchor" aria-label="anchor" href="#cross-sectional-framework"></a>
</h3>
<p>Let’s take a look at how <code>FoReco</code> can be used for
cross-sectional reconciliation. In this scenario, we use the <a href="https://search.r-project.org/R/refmans/datasets/html/UKLungDeaths.html" class="external-link">UKLungDeaths</a>
dataset containing the monthly deaths from bronchitis, emphysema, and
asthma in the UK from 1974 to 1979 for both sexes
(<strong>Total</strong>), males (<strong>Male</strong>) and females
(<strong>Female</strong>). We want to generate coherent forecasts for
these variables, such that <span class="math inline">\(Total = Male +
Female\)</span> at any time.</p>
<p><img src="FoReco_prob_files/figure-html/cs_plot-1.png" width="576" style="display: block; margin: auto;"></p>
<p>We start by arranging the data frame of deaths, the aggregation
matrix, and the constraint matrix. Then, we generate the base forecasts
with ETS model using the functions <a href="https://pkg.robjhyndman.com/forecast/reference/ets.html" class="external-link"><code>ets()</code></a>
and <a href="https://pkg.robjhyndman.com/forecast/reference/forecast.ets.html" class="external-link"><code>forecast()</code></a>
from the package <a href="https://pkg.robjhyndman.com/forecast/index.html" class="external-link"><strong>forecast</strong></a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cross-sectional setup</span></span>
<span><span class="va">tdeaths</span> <span class="op">&lt;-</span> <span class="va">mdeaths</span> <span class="op">+</span> <span class="va">fdeaths</span></span>
<span><span class="va">agg_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cons_cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>,<span class="op">-</span><span class="va">agg_mat</span><span class="op">)</span></span>
<span><span class="va">lungDeaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">tdeaths</span>, <span class="va">mdeaths</span>, <span class="va">fdeaths</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">lungDeaths</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/ets.html" class="external-link">ets</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">x</span>, frequency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">lungDeaths</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">forecast_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">forecast</span>, h<span class="op">=</span><span class="fl">12</span><span class="op">)</span>      <span class="co"># forecast object</span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">forecast_obj</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span> <span class="co"># base mean (point forecasts)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span>   <span class="co"># in-sample residuals (one-step)</span></span></code></pre></div>
<p>We know that a sample from the reconciled distribution can be
obtained by reconciling each member of a sample from the incoherent
distribution (Panagiotelis et al., 2022). This finding enables us to
distinguish the process of generating the base forecast samples from the
reconciliation phase. To generate an incoherent sample, we can use a
non-parametric (such as the joint block bootstrap) or a parametric
approach (by assuming gaussianity).</p>
<div class="section level4">
<h4 id="bootstrap-approach">Bootstrap approach<a class="anchor" aria-label="anchor" href="#bootstrap-approach"></a>
</h4>
<p>We can implement the block bootstrap method proposed by Panagiotelis
et al. (2022) using the <code><a href="../reference/boot_cs.html">boot_cs()</a></code> function. This function
requires three inputs: the <strong>fit</strong> parameter, which is a
list of models (e.g., the three ETS models used to forecast); the
<strong>boot_size</strong> parameter, which specifies the number of
bootstrap replications; <strong>h</strong>, which denotes the block
size, typically equivalent to the forecast horizon. It is important to
note that the models used have the <a href="https://pkg.robjhyndman.com/forecast/simulate.ets.html" class="external-link"><code>simulate()</code></a>
function available and implemented similarly to the package <a href="https://pkg.robjhyndman.com/forecast/" class="external-link"><strong>forecast</strong></a>
(Hyndman et al. 2023), with the following mandatory parameters:
<strong>object</strong>, <strong>innov</strong>,
<strong>future</strong>, and <strong>nsim</strong>. The outputs of the
function are the seed used to sample the errors, and a 3-d array (<span class="math inline">\(\mathrm{boot\_size} \times n \times h\)</span>),
which can be reconciled using the <code><a href="../reference/htsrec.html">htsrec()</a></code> function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base forecasts' sample:</span></span>
<span><span class="co"># we simulate from the base models by sampling errors </span></span>
<span><span class="co"># while keeping the cross-sectional dimension fixed.</span></span>
<span><span class="va">base_csjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/boot_cs.html">boot_cs</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">B</span>, <span class="fl">12</span><span class="op">)</span><span class="op">$</span><span class="va">sample</span> </span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/norm-methods.html" class="external-link">norm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_csjb</span>, <span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency for all the samples</span></span>
<span><span class="co">#&gt; [1] 119495.1</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample: </span></span>
<span><span class="co"># we reconcile each member of a sample from the incoherent distribution.</span></span>
<span><span class="va">reco_csjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_csjb</span>, <span class="fl">3</span>, <span class="va">htsrec</span>, C <span class="op">=</span> <span class="va">agg_mat</span>, res <span class="op">=</span> <span class="va">res</span>, </span>
<span>                   comb <span class="op">=</span> <span class="st">"shr"</span>, keep <span class="op">=</span> <span class="st">"recf"</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">reco_csjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">simplify2array</a></span><span class="op">(</span><span class="va">reco_csjb</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">reco_csjb</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/norm-methods.html" class="external-link">norm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">reco_csjb</span>, <span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency</span></span>
<span><span class="co">#&gt; [1] 1.482476e-10</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="gaussian-approach">Gaussian approach<a class="anchor" aria-label="anchor" href="#gaussian-approach"></a>
</h4>
<p>To obtain the base forecasts assuming Gaussianity (Panagiotelis et
al. 2022), we can use packages to simulate from a multivariate normal
distribution such as <a href="https://CRAN.R-project.org/package=MASS" class="external-link"><strong>MASS</strong></a>
(Venables and Ripley 2002). We can then apply the <code><a href="../reference/htsrec.html">htsrec()</a></code>
function to obtain the reconciled sample. When dealing with multiple
forecast horizons, it is recommended to utilize multi-step residuals
instead of one-step residuals (see Girolimetto et al. 2023).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Multi-step residuals</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span>, h <span class="op">=</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># List of H=12 covariance matrix (one for each forecast horizon)</span></span>
<span><span class="va">cov_shr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">hres</span>, <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="fu"><a href="../reference/shrink_estim.html">shrink_estim</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">$</span><span class="va">scov</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Base forecasts' sample:</span></span>
<span><span class="co"># we simulate from a multivariate normal distribution.</span></span>
<span><span class="va">base_csg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">B</span>, mu <span class="op">=</span> <span class="va">base</span><span class="op">[</span><span class="va">h</span>, <span class="op">]</span>, Sigma <span class="op">=</span> <span class="va">cov_shr</span><span class="op">[[</span><span class="va">h</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">base_csg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">simplify2array</a></span><span class="op">(</span><span class="va">base_csg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_csg</span>, <span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency</span></span>
<span><span class="co">#&gt; [1] 1225671</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample:</span></span>
<span><span class="co"># we reconcile each member of the base forecasts' sample.</span></span>
<span><span class="va">reco_csg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_csg</span>, <span class="fl">3</span>, <span class="va">htsrec</span>, C <span class="op">=</span> <span class="va">agg_mat</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"shr"</span>, keep <span class="op">=</span> <span class="st">"recf"</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">reco_csg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">simplify2array</a></span><span class="op">(</span><span class="va">reco_csg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">reco_csg</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">reco_csg</span>, <span class="fl">3</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cons_cs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Check the coherency</span></span>
<span><span class="co">#&gt; [1] 1.064137e-09</span></span></code></pre></div>
<p><img src="FoReco_prob_files/figure-html/csplot-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level3">
<h3 id="temporal-framework">Temporal framework<a class="anchor" aria-label="anchor" href="#temporal-framework"></a>
</h3>
<p>In the temporal framework, we reconcile base forecasts across
different time frequencies (e.g., monthly, quarterly, and annual data)
for a single time series. For example, suppose we want to generate
reconciled monthly, quarterly, and annual forecasts for the total number
of deaths due to bronchitis, emphysema, and asthma in the UK. According
to Girolimetto et al. (2023), we can use the same approach as in the
cross-sectional framework, but we need to account for the different time
frequencies.</p>
<p>In the bootstrap approach, we can use the <code><a href="../reference/boot_te.html">boot_te()</a></code>
function, which generates a bootstrap sample for time-series forecasts
while keeping a temporal structure. The function requires the same
inputs as the equivalent cross-sectional <code><a href="../reference/boot_cs.html">boot_cs()</a></code>
function, with an additional parameter <strong>m</strong> that indicates
the maximum order of temporal aggregation. The length of the block
bootstrap is determined by both <strong>m</strong> and
<strong>h</strong>, where <strong>h</strong> refers to the forecast
horizons for the most temporally aggregated series.</p>
<p>In the Gaussian approach, we assume that all the base forecasts
follow a multivariate normal distribution, and we calculate the
covariance matrix of the base forecasts using multi-step residuals
organized in matrix form through the <code><a href="../reference/residuals_matrix.html">residuals_matrix()</a></code>
function.</p>
<p>To reconcile each sample we use the optimal temporal reconclition
function, <code><a href="../reference/thfrec.html">thfrec()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Temporal setup</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">tdeaths</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fl">12</span></span>
<span><span class="va">kset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># factors subset of m = 12 </span></span>
<span>                    <span class="co"># (only monthly, quarterly and annual data are considered)</span></span>
<span><span class="va">kset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">kset</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"k"</span>, <span class="va">kset</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cons_te</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thf_tools.html">thf_tools</a></span><span class="op">(</span>m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span><span class="op">$</span><span class="va">Zt</span></span>
<span></span>
<span><span class="va">temp_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">kset</span>, <span class="va">agg_ts</span>, x <span class="op">=</span> <span class="va">y</span><span class="op">)</span>                         <span class="co"># Aggregated time series list</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">temp_y</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/ets.html" class="external-link">ets</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">x</span>, frequency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">forecast_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">tsfit</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">tsfit</span>, h<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">tsfit</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>                      <span class="co"># forecast object</span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">forecast_obj</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span>              <span class="co"># base mean </span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span>   <span class="co"># in-sample residuals (one-step)</span></span></code></pre></div>
<div class="section level4">
<h4 id="bootstrap-approach-1">Bootstrap approach<a class="anchor" aria-label="anchor" href="#bootstrap-approach-1"></a>
</h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base forecasts' sample:</span></span>
<span><span class="co"># we simulate from the base models by sampling errors </span></span>
<span><span class="co"># while keeping the temporal dimension fixed.</span></span>
<span><span class="va">base_tejb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/boot_te.html">boot_te</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">B</span>, m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span><span class="op">$</span><span class="va">sample</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample:</span></span>
<span><span class="co"># we reconcile each member of the base forecasts' sample.</span></span>
<span><span class="va">reco_tejb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_tejb</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">boot_base</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/thfrec.html">thfrec</a></span><span class="op">(</span><span class="va">boot_base</span>, m <span class="op">=</span> <span class="va">kset</span>, res <span class="op">=</span> <span class="va">res</span>, comb <span class="op">=</span> <span class="st">"wlsv"</span>, keep <span class="op">=</span> <span class="st">"recf"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="gaussian-approach-1">Gaussian approach<a class="anchor" aria-label="anchor" href="#gaussian-approach-1"></a>
</h4>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Multi-step residuals</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">mod</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">mod</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">mod</span>, type<span class="op">=</span><span class="st">'response'</span>, h <span class="op">=</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">hres</span>, <span class="va">arrange_hres</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Re-arrenge multi-step residuals in a matrix form</span></span>
<span><span class="va">mres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/residuals_matrix.html">residuals_matrix</a></span><span class="op">(</span><span class="va">hres</span>, m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Base forecasts' sample:</span></span>
<span><span class="co"># we simulate from a multivariate normal distribution.</span></span>
<span><span class="va">base_teg</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">B</span>, mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">base</span><span class="op">)</span>, Sigma <span class="op">=</span> <span class="fu"><a href="../reference/shrink_estim.html">shrink_estim</a></span><span class="op">(</span><span class="va">mres</span><span class="op">)</span><span class="op">$</span><span class="va">scov</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample:</span></span>
<span><span class="co"># we reconcile each member of the base forecasts' sample.</span></span>
<span><span class="va">reco_teg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_teg</span>, <span class="fl">1</span>, <span class="va">thfrec</span>, m <span class="op">=</span> <span class="va">kset</span>, comb <span class="op">=</span> <span class="st">"wlsv"</span>, res <span class="op">=</span> <span class="va">res</span>, keep <span class="op">=</span> <span class="st">"recf"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="FoReco_prob_files/figure-html/teplot-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level3">
<h3 id="cross-temporal-framework">Cross-temporal framework<a class="anchor" aria-label="anchor" href="#cross-temporal-framework"></a>
</h3>
<p>Finally, we obtain probabilistic reconciled forecasts in the
cross-temporal framework. We use the <code><a href="../reference/boot_ct.html">boot_ct()</a></code> function
with almost the same input as <code><a href="../reference/boot_te.html">boot_te()</a></code> to implement the
bootstrap approach. The <strong>fit</strong> parameter in this case has
to consider the model for all the series at different frequency.</p>
<p>For the Gaussian approach, we can use the <code><a href="../reference/arrange_hres.html">arrange_hres()</a></code>
and <code><a href="../reference/residuals_matrix.html">residuals_matrix()</a></code> functions to arrange residuals for
the covariance matrix of the base forecasts.</p>
<p>Finally, we can reconcile the base forecasts samples with the optimal
cross-temporal reconciliation <code><a href="../reference/octrec.html">octrec()</a></code> (or we can use other
heuristic alternatives, e.g. <code><a href="../reference/iterec.html">iterec()</a></code>).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cross-temporal setup</span></span>
<span><span class="va">ctlungDeaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">kset</span>, <span class="va">agg_ts</span>, x <span class="op">=</span> <span class="va">lungDeaths</span><span class="op">)</span> <span class="co"># Aggregated multivariate time series list</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ctlungDeaths</span>, <span class="kw">function</span><span class="op">(</span><span class="va">tsk</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">tsk</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/ets.html" class="external-link">ets</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/ts.html" class="external-link">ts</a></span><span class="op">(</span><span class="va">x</span>, frequency <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">tsk</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">forecast_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fitk</span><span class="op">)</span>           <span class="co"># forecast object</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fitk</span>, <span class="kw">function</span><span class="op">(</span><span class="va">tsfit</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">tsfit</span>, h<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">tsfit</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">base</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">forecast_obj</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fmodk</span><span class="op">)</span>     <span class="co"># base mean </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fmodk</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fitk</span><span class="op">)</span>    <span class="co"># in-sample residuals (one-step)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fitk</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="bootstrap-approach-2">Bootstrap approach<a class="anchor" aria-label="anchor" href="#bootstrap-approach-2"></a>
</h4>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Base forecasts' sample:</span></span>
<span><span class="co"># we simulate from the base models by sampling errors </span></span>
<span><span class="co"># while keeping the cross-sectional and temporal dimensions fixed.</span></span>
<span><span class="va">base_ctjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/boot_ct.html">boot_ct</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">B</span>, m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span><span class="op">$</span><span class="va">sample</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample: </span></span>
<span><span class="co"># we reconcile each member of the base forecasts' sample.</span></span>
<span><span class="va">reco_ctjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_ctjb</span>, <span class="kw">function</span><span class="op">(</span><span class="va">boot_base</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/octrec.html">octrec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">boot_base</span><span class="op">)</span>, m <span class="op">=</span> <span class="va">kset</span>, C <span class="op">=</span> <span class="va">agg_mat</span>, res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, comb <span class="op">=</span> <span class="st">"bdshr"</span>, keep <span class="op">=</span> <span class="st">"recf"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">reco_ctjb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">reco_ctjb</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">`rownames&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="gaussian-approach-2">Gaussian approach<a class="anchor" aria-label="anchor" href="#gaussian-approach-2"></a>
</h4>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Multi-step residuals</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">fitk</span><span class="op">)</span>    <span class="co"># in-sample residuals (one-step)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html" class="external-link">frequency</a></span><span class="op">(</span><span class="va">fitk</span><span class="op">$</span><span class="va">tdeaths</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">h</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fitk</span>, <span class="va">residuals</span>, type<span class="op">=</span><span class="st">'response'</span>, h <span class="op">=</span> <span class="va">h</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">hres</span>, <span class="va">arrange_hres</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Re-arrenge multi-step residuals in a matrix form</span></span>
<span><span class="va">mres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/residuals_matrix.html">residuals_matrix</a></span><span class="op">(</span><span class="va">hres</span>, m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Base forecasts' sample:</span></span>
<span><span class="co"># we simulate from a multivariate normal distribution.</span></span>
<span><span class="va">base_ctg</span> <span class="op">&lt;-</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">B</span>, mu <span class="op">=</span> <span class="fu"><a href="../reference/residuals_matrix.html">residuals_matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">base</span><span class="op">)</span><span class="op">)</span>, m <span class="op">=</span> <span class="va">kset</span><span class="op">)</span>, </span>
<span>                          Sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">mres</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">base_ctg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">base_ctg</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">x</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Reconciled forecasts' sample:</span></span>
<span><span class="co"># we reconcile each member of the base forecasts' sample.</span></span>
<span><span class="va">reco_ctg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">base_ctg</span>, <span class="kw">function</span><span class="op">(</span><span class="va">boot_base</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">FoReco026</span><span class="fu">::</span><span class="fu"><a href="../reference/octrec.html">octrec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">boot_base</span><span class="op">)</span>, m <span class="op">=</span> <span class="va">kset</span>, C <span class="op">=</span> <span class="va">agg_mat</span>, res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>, comb <span class="op">=</span> <span class="st">"bdshr"</span>, </span>
<span>         keep <span class="op">=</span> <span class="st">"recf"</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">reco_ctg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">reco_ctg</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">`rownames&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="FoReco_prob_files/figure-html/ctplot-1.png" width="700" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Girolimetto, D., Athanasopoulos, G., Di Fonzo, T., and Hyndman, R. J.
(2023), Cross-temporal Probabilistic Forecast Reconciliation, <a href="https://doi.org/10.48550/arXiv.2303.17277" class="external-link uri">https://doi.org/10.48550/arXiv.2303.17277</a> .</p>
<p>Hyndman R, Athanasopoulos G, Bergmeir C, Caceres G, Chhay L,
O’Hara-Wild M, Petropoulos F, Razbash S, Wang E, Yasmeen F (2023).
<em>forecast: Forecasting functions for time series and linear
models</em> . R package version 8.20, <a href="https://pkg.robjhyndman.com/forecast/" class="external-link uri">https://pkg.robjhyndman.com/forecast/</a>.</p>
<p>Panagiotelis, A., Gamakumara, P., Athanasopoulos, G. and Hyndman, R.
J. (2023), Probabilistic forecast reconciliation: Properties, evaluation
and score optimisation, <em>European Journal of Operational
Research</em> 306(2), 693–706, <a href="https://doi.org/10.1016/j.ejor.2022.07.040" class="external-link uri">https://doi.org/10.1016/j.ejor.2022.07.040</a> .</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Daniele Girolimetto, Tommaso Di Fonzo.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
